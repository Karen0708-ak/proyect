<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${actividadAccion.codigoActividad != null ? 'Editar actividad' : 'Nueva actividad'}">Formulario Actividad</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(145deg, #f0fdf4, #dcfce7);
            color: #0f172a;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        .form-wrapper {
            padding-top: 96px;
        }
        .shell {
            background: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.1);
            border-radius: 16px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
        }
        .form-label {
            font-weight: 700;
        }
        .help-text {
            color: #64748b;
            font-size: .86rem;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <main class="container py-4 form-wrapper">
        <section class="shell p-4 p-md-5">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
                <div>
                    <h1 class="h3 mb-1" th:text="${actividadAccion.codigoActividad != null ? 'Editar actividad' : 'Nueva actividad'}"></h1>
                    <p class="mb-0 text-muted">Complete los campos requeridos para guardar la actividad.</p>
                </div>
                <a th:href="@{/actividades}" class="btn btn-outline-dark">Volver al listado</a>
            </div>

            <form th:object="${actividadAccion}"
                  th:action="${actividadAccion.codigoActividad != null} ? @{/actividades/actualizar/{id}(id=${actividadAccion.codigoActividad})} : @{/actividades/guardar}"
                  method="post"
                  id="actividadForm"
                  novalidate>

                <input type="hidden" th:if="${actividadAccion.codigoActividad != null}" th:field="*{codigoActividad}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Numero de actividad</label>
                        <input type="number" class="form-control" th:field="*{numeroActividad}" min="1" required>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('numeroActividad')}" th:errors="*{numeroActividad}"></div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Fecha inicial</label>
                        <input type="date" class="form-control" th:field="*{fechaInicialActividad}" required>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaInicialActividad')}" th:errors="*{fechaInicialActividad}"></div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Fecha maxima</label>
                        <input type="date" class="form-control" th:field="*{fechaMaxActividad}" required>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaMaxActividad')}" th:errors="*{fechaMaxActividad}"></div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Estado</label>
                        <select class="form-select" th:field="*{estadoActividad}" required>
                            <option value="">Seleccione...</option>
                            <option value="PENDIENTE">PENDIENTE</option>
                            <option value="EN_PROGRESO">EN_PROGRESO</option>
                            <option value="COMPLETADO">COMPLETADO</option>
                            <option value="CANCELADO">CANCELADO</option>
                        </select>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('estadoActividad')}" th:errors="*{estadoActividad}"></div>
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">Accion del plan ambiental</label>
                        <select class="form-select" th:field="*{accionPlanAmbiental.codigoAccion}" required>
                            <option value="">Seleccione una accion...</option>
                            <option th:each="accion : ${accionesDisponibles}"
                                    th:value="${accion.codigoAccion}"
                                    th:text="${accion.aspectoAmbientalAccion}">
                            </option>
                        </select>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('accionPlanAmbiental')}" th:errors="*{accionPlanAmbiental}"></div>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('accionPlanAmbiental.codigoAccion')}" th:errors="*{accionPlanAmbiental.codigoAccion}"></div>
                        <small class="help-text d-block mt-1">Debe seleccionar una accion existente.</small>
                    </div>

                    <div class="col-12">
                        <div class="invalid-feedback d-block"
                             th:if="${#fields.hasErrors('rangoFechasValido')}"
                             th:errors="*{rangoFechasValido}"></div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <a th:href="@{/actividades}" class="btn btn-outline-secondary btn-cancelar-actividad">Cancelar</a>
                </div>
            </form>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var form = document.getElementById('actividadForm');
            var fechaInicialInput = document.getElementById('fechaInicialActividad');
            var fechaMaxInput = document.getElementById('fechaMaxActividad');

            form.addEventListener('submit', function (event) {
                var valido = form.checkValidity();

                if (fechaInicialInput.value && fechaMaxInput.value && fechaMaxInput.value < fechaInicialInput.value) {
                    valido = false;
                    fechaMaxInput.setCustomValidity('La fecha maxima debe ser posterior o igual a la fecha inicial.');
                } else {
                    fechaMaxInput.setCustomValidity('');
                }

                if (!valido) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });

            fechaInicialInput.addEventListener('change', function () {
                if (fechaInicialInput.value) {
                    fechaMaxInput.min = fechaInicialInput.value;
                }
            });

            document.querySelectorAll('.btn-cancelar-actividad').forEach(function (btn) {
                btn.addEventListener('click', function (event) {
                    event.preventDefault();
                    var href = btn.getAttribute('href');
                    Swal.fire({
                        title: 'Cancelar cambios?',
                        text: 'Se perderan los cambios no guardados.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Si, cancelar',
                        cancelButtonText: 'Seguir editando',
                        confirmButtonColor: '#0d6efd',
                        cancelButtonColor: '#6c757d'
                    }).then(function (result) {
                        if (result.isConfirmed && href) {
                            window.location.href = href;
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>
