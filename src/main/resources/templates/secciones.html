<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Secciones del Plan Ambiental</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --base-bg: #f1f5f9;
            --base-card: #ffffff;
            --base-head: #0f172a;
        }
        body {
            background: linear-gradient(150deg, #e2e8f0, var(--base-bg));
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: #0f172a;
        }
        .shell {
            background: var(--base-card);
            border-radius: 16px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }
        .table thead th {
            background: var(--base-head);
            color: #fff;
            border-bottom: 0;
        }
        .truncate {
            max-width: 280px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <main class="container-fluid py-4">
        <section class="shell p-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
                <div>
                    <h1 class="h3 mb-1">Secciones del Plan Ambiental</h1>
                    <p class="mb-0 text-muted">CRUD completo para admin y visualizacion para usuario.</p>
                </div>
                <div class="d-flex gap-2">
                    <button th:if="${isAdmin}" type="button" class="btn btn-success"
                            data-bs-toggle="modal" data-bs-target="#seccionModal">
                        Nueva seccion
                    </button>
                    <a th:href="@{/acciones}" class="btn btn-outline-primary">Ir a acciones</a>
                    <a th:href="@{/home}" class="btn btn-outline-dark">Volver al panel</a>
                </div>
            </div>

            <div class="alert alert-secondary border mb-4">
                Pantalla activa de secciones. El formulario se abre en un modal.
            </div>

            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

            <div th:if="${!isAdmin}" class="alert alert-info mb-4">
                Tu perfil es de solo lectura. Puedes visualizar y filtrar, pero no crear ni editar.
            </div>

            <table id="tablaSecciones" class="table table-hover table-striped w-100 align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Numero</th>
                        <th>Titulo</th>
                        <th>Objetivo</th>
                        <th>Color</th>
                        <th>Creado</th>
                        <th>Editado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="s : ${secciones}">
                        <td th:text="${s.codigoSeccion}"></td>
                        <td th:text="${s.numeroSeccion}"></td>
                        <td th:text="${s.tituloSeccion}"></td>
                        <td class="truncate" th:text="${s.objetivoSeccion}" th:title="${s.objetivoSeccion}"></td>
                        <td th:text="${s.colorSeccion}"></td>
                        <td th:text="${s.fechaCreadoSeccion != null ? #temporals.format(s.fechaCreadoSeccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td th:text="${s.fechaEditadoSeccion != null ? #temporals.format(s.fechaEditadoSeccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td>
                            <div th:if="${isAdmin}" class="d-flex gap-2">
                                <a th:href="@{/secciones(editar=${s.codigoSeccion})}" class="btn btn-sm btn-outline-warning">Editar</a>
                                <form th:action="@{/secciones/eliminar/{id}(id=${s.codigoSeccion})}" method="post"
                                      onsubmit="return confirm('Deseas eliminar esta seccion?');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                </form>
                            </div>
                            <span th:if="${!isAdmin}" class="badge text-bg-secondary">Sin permisos</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <div th:if="${isAdmin}" class="modal fade" id="seccionModal" tabindex="-1" aria-labelledby="seccionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="seccionModalLabel"
                        th:text="${modoEdicion} ? 'Editar seccion' : 'Nueva seccion'">Nueva seccion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/secciones/guardar}" th:object="${seccionForm}" method="post">
                    <div class="modal-body">
                        <input type="hidden" th:field="*{codigoSeccion}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Numero seccion</label>
                                <input class="form-control" type="number" min="1" th:field="*{numeroSeccion}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Titulo</label>
                                <input class="form-control" type="text" maxlength="255" th:field="*{tituloSeccion}" required>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Color</label>
                                <input class="form-control" type="text" maxlength="25" th:field="*{colorSeccion}" placeholder="Verde">
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Objetivo</label>
                                <textarea class="form-control" rows="3" th:field="*{objetivoSeccion}"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a th:if="${modoEdicion}" th:href="@{/secciones}" class="btn btn-outline-secondary">Cancelar</a>
                        <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-success"
                                th:text="${modoEdicion} ? 'Actualizar seccion' : 'Guardar seccion'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script th:inline="none">
        $(function () {
            $('#tablaSecciones').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [ [5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos'] ],
                order: [ [0, 'desc'] ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
                }
            });
        });
    </script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var modoEdicion = /*[[${modoEdicion}]]*/ false;
            if (modoEdicion) {
                var modalEl = document.getElementById('seccionModal');
                if (modalEl) {
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                }
            }
        });
    </script>
</body>
</html>
