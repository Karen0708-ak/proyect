<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Secciones del Plan Ambiental</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --base-bg: #f1f5f9;
            --base-card: #ffffff;
            --base-head: #0f172a;
            --border: #dbe3ee;
            --danger: #dc3545;
        }
        body {
            background: linear-gradient(150deg, #e2e8f0, var(--base-bg));
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: #0f172a;
        }
        .shell {
            background: var(--base-card);
            border-radius: 16px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }
        .table thead th {
            background: var(--base-head);
            color: #fff;
            border-bottom: 0;
        }
        .truncate {
            max-width: 280px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-wrapper {
            padding-top: 96px;
        }
        .dt-buttons .btn {
            margin-right: 0.4rem;
            margin-bottom: 0.4rem;
        }
        .modal-content {
            max-height: calc(100vh - 2rem);
        }
        .modal-body {
            overflow-y: auto;
        }
        .form-label {
            font-weight: 700;
            color: #111827;
        }
        .form-control,
        .form-select {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 0.62rem 0.82rem;
            transition: all .2s ease;
        }
        .form-control:focus,
        .form-select:focus {
            border-color: rgba(60, 141, 188, .55);
            box-shadow: 0 0 0 .2rem rgba(60, 141, 188, .15);
        }
        .help-text {
            color: #6b7280;
            font-size: .84rem;
        }
        .invalid-feedback {
            display: block;
            font-size: .86rem;
        }
        .is-invalid {
            border-color: var(--danger) !important;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <main class="container-fluid py-4 list-wrapper">
        <section class="shell p-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
                <div>
                    <h1 class="h3 mb-1">Secciones del Plan Ambiental</h1>
                    
                </div>
                <div class="d-flex gap-2">
                    <button th:if="${isAdmin}" type="button" class="btn btn-success"
                            data-bs-toggle="modal" data-bs-target="#seccionModal">
                        Nueva seccion
                    </button>
                    <a th:href="@{/acciones}" class="btn btn-outline-primary">Ir a acciones</a>
                    <a th:href="@{/home}" class="btn btn-outline-dark">Volver al panel</a>
                </div>
            </div>

            <div th:if="${!isAdmin}" class="alert alert-info mb-4">
                Tu perfil es de solo lectura. Puedes visualizar y filtrar, pero no crear ni editar.
            </div>

            <table id="tablaSecciones" class="table table-hover table-striped w-100 align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Numero</th>
                        <th>Titulo</th>
                        <th>Objetivo</th>
                        <th>Color</th>
                        <th>Creado</th>
                        <th>Editado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="s : ${secciones}">
                        <td th:text="${s.codigoSeccion}"></td>
                        <td th:text="${s.numeroSeccion}"></td>
                        <td th:text="${s.tituloSeccion}"></td>
                        <td class="truncate" th:text="${s.objetivoSeccion}" th:title="${s.objetivoSeccion}"></td>
                        <td th:text="${s.colorSeccion}"></td>
                        <td th:text="${s.fechaCreadoSeccion != null ? #temporals.format(s.fechaCreadoSeccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td th:text="${s.fechaEditadoSeccion != null ? #temporals.format(s.fechaEditadoSeccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td>
                            <div th:if="${isAdmin}" class="d-flex gap-2">
                                <a th:href="@{/secciones(editar=${s.codigoSeccion})}" class="btn btn-sm btn-outline-warning">Editar</a>
                                <form th:action="@{/secciones/eliminar/{id}(id=${s.codigoSeccion})}" method="post"
                                      class="form-eliminar"
                                      th:attr="data-nombre=${'Seccion ' + s.numeroSeccion + ' - ' + s.tituloSeccion}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                </form>
                            </div>
                            <span th:if="${!isAdmin}" class="badge text-bg-secondary">Sin permisos</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <div th:if="${isAdmin}" class="modal fade" id="seccionModal" tabindex="-1" aria-labelledby="seccionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="seccionModalLabel"
                        th:text="${modoEdicion} ? 'Editar seccion' : 'Nueva seccion'">Nueva seccion</h5>
                    <button type="button" class="btn-close btn-close-white btn-cancelar-modal-seccion" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/secciones/guardar}" th:object="${seccionForm}" method="post" id="formSeccion" novalidate>
                    <div class="modal-body">
                        <input type="hidden" th:field="*{codigoSeccion}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="alert alert-danger" th:if="${#fields.hasAnyErrors()}">
                            <ul class="mb-0">
                                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                            </ul>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Numero seccion</label>
                                <input class="form-control" type="number" min="1" max="9999" th:field="*{numeroSeccion}" required placeholder="Ej: 1">
                                <small class="help-text d-block mt-1">Solo numeros positivos. Ejemplo: 1, 2, 10.</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Titulo</label>
                                <input class="form-control" type="text" maxlength="255" th:field="*{tituloSeccion}" required placeholder="Ej: Gestion de residuos solidos">
                                <small class="help-text d-block mt-1">Describe el nombre de la seccion de forma clara.</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Color</label>
                                <input class="form-control" type="text" maxlength="25" th:field="*{colorSeccion}" placeholder="Ej: Verde o #28a745">
                                <small class="help-text d-block mt-1">Opcional. Puedes usar nombre o codigo HEX.</small>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Objetivo</label>
                                <textarea class="form-control" rows="3" th:field="*{objetivoSeccion}" maxlength="4000" placeholder="Ej: Reducir la generacion de residuos en un 20% durante el primer semestre."></textarea>
                                <small class="help-text d-block mt-1">Opcional. Explica brevemente la meta de la seccion.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a th:if="${modoEdicion}" th:href="@{/secciones}" class="btn btn-outline-secondary btn-cancelar-seccion">Cancelar</a>
                        <button type="button" class="btn btn-light border btn-cancelar-modal-seccion" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-success"
                                th:text="${modoEdicion} ? 'Actualizar seccion' : 'Guardar seccion'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="none">
        $(function () {
            $('#tablaSecciones').DataTable({
                responsive: true,
                dom: "<'row mb-2'<'col-md-7'B><'col-md-5'f>>" +
                     "rt" +
                     "<'row mt-3'<'col-md-5'i><'col-md-7'p>>",
                buttons: [
                    { extend: 'copy', text: 'Copiar', className: 'btn btn-secondary btn-sm' },
                    { extend: 'csv', text: 'CSV', className: 'btn btn-success btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } },
                    { extend: 'excel', text: 'Excel', className: 'btn btn-success btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } },
                    { extend: 'pdf', text: 'PDF', className: 'btn btn-danger btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } },
                    { extend: 'print', text: 'Imprimir', className: 'btn btn-dark btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } }
                ],
                pageLength: 10,
                lengthMenu: [ [5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos'] ],
                order: [ [0, 'desc'] ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
                }
            });
        });
    </script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var modoEdicion = /*[[${modoEdicion}]]*/ false;
            var abrirModal = /*[[${abrirModal}]]*/ false;
            var successMessage = /*[[${successMessage}]]*/ null;
            var errorMessage = /*[[${errorMessage}]]*/ null;

            function alertaExito(mensaje) {
                Swal.fire({
                    icon: 'success',
                    title: 'Operacion exitosa',
                    text: mensaje,
                    confirmButtonColor: '#198754'
                });
            }

            function alertaError(mensaje) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ocurrio un problema',
                    text: mensaje,
                    confirmButtonColor: '#dc3545'
                });
            }

            function alertaConfirmar(config) {
                return Swal.fire({
                    title: config.titulo,
                    html: config.html,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: config.confirmText || 'Confirmar',
                    cancelButtonText: config.cancelText || 'Cancelar',
                    confirmButtonColor: config.confirmColor || '#dc3545',
                    cancelButtonColor: '#6c757d'
                });
            }

            if (successMessage) {
                alertaExito(successMessage);
            } else if (errorMessage) {
                alertaError(errorMessage);
            }

            if (modoEdicion || abrirModal) {
                var modalEl = document.getElementById('seccionModal');
                if (modalEl) {
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                }
            }

            $(document).on('submit', '.form-eliminar', function (e) {
                e.preventDefault();
                var form = this;
                var nombre = $(form).data('nombre') || 'esta seccion';

                alertaConfirmar({
                    titulo: 'Eliminar seccion?',
                    html: 'Vas a eliminar <b>' + nombre + '</b><br><span class="text-muted">Esta accion no se puede deshacer</span>',
                    confirmText: 'Eliminar',
                    cancelText: 'Cancelar',
                    confirmColor: '#dc3545'
                }).then(function (result) {
                    if (result.isConfirmed) {
                        form.submit();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Operacion cancelada',
                            text: 'No se elimino la seccion.',
                            timer: 1200,
                            showConfirmButton: false
                        });
                    }
                });
            });

            $(document).on('click', '.btn-cancelar-seccion', function (e) {
                e.preventDefault();
                var href = this.getAttribute('href');
                alertaConfirmar({
                    titulo: 'Cancelar cambios?',
                    html: 'Se perderan los cambios no guardados.',
                    confirmText: 'Si, cancelar',
                    cancelText: 'Seguir editando',
                    confirmColor: '#0d6efd'
                }).then(function (result) {
                    if (result.isConfirmed && href) {
                        window.location.href = href;
                    }
                });
            });

            $(document).on('click', '.btn-cancelar-modal-seccion', function () {
                Swal.fire({
                    icon: 'info',
                    title: 'Operacion cancelada',
                    text: 'Formulario cerrado.',
                    timer: 1200,
                    showConfirmButton: false
                });
            });

            $('#seccionModal').on('shown.bs.modal', function () {
                var body = this.querySelector('.modal-body');
                if (body) {
                    body.scrollTop = 0;
                }
            });

            $.validator.addMethod("soloEnteros", function (value, element) {
                return this.optional(element) || /^\d+$/.test(value);
            }, "Solo se permiten numeros enteros.");

            $("#formSeccion").validate({
                ignore: [],
                rules: {
                    numeroSeccion: {
                        required: true,
                        soloEnteros: true,
                        min: 1,
                        max: 9999
                    },
                    tituloSeccion: {
                        required: true,
                        minlength: 3,
                        maxlength: 255
                    },
                    colorSeccion: {
                        maxlength: 25
                    },
                    objetivoSeccion: {
                        maxlength: 4000
                    }
                },
                messages: {
                    numeroSeccion: {
                        required: "Ingresa el numero de seccion.",
                        min: "Debe ser mayor o igual a 1.",
                        max: "No puede superar 9999."
                    },
                    tituloSeccion: {
                        required: "Ingresa el titulo de la seccion.",
                        minlength: "Debe tener al menos 3 caracteres.",
                        maxlength: "No puede superar 255 caracteres."
                    },
                    colorSeccion: {
                        maxlength: "No puede superar 25 caracteres."
                    },
                    objetivoSeccion: {
                        maxlength: "No puede superar 4000 caracteres."
                    }
                },
                errorElement: "div",
                errorClass: "invalid-feedback",
                highlight: function (element) { $(element).addClass("is-invalid"); },
                unhighlight: function (element) { $(element).removeClass("is-invalid"); },
                submitHandler: function (form) { form.submit(); }
            });
        });
    </script>
</body>
</html>
