<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Acciones del Plan Ambiental</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --head: #0b3a53;
            --border: #dbe3ee;
            --danger: #dc3545;
        }
        body {
            background: radial-gradient(circle at 20% 20%, #cbd5e1, #f8fafc 38%),
                        linear-gradient(140deg, #e2e8f0, #f8fafc);
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: #0b3a53;
        }
        .shell {
            background: #fff;
            border-radius: 16px;
            border: 1px solid rgba(11, 58, 83, 0.15);
            box-shadow: 0 18px 40px rgba(11, 58, 83, 0.12);
        }
        .table thead th {
            background: var(--head);
            color: #fff;
            border-bottom: 0;
        }
        .truncate {
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-wrapper {
            padding-top: 96px;
        }
        .dt-buttons .btn {
            margin-right: 0.4rem;
            margin-bottom: 0.4rem;
        }
        .modal-content {
            max-height: calc(100vh - 2rem);
        }
        .modal-dialog.modal-dialog-scrollable {
            height: calc(100vh - 1rem);
        }
        .modal-dialog-scrollable .modal-content {
            max-height: 100%;
        }
        .modal-dialog-scrollable .modal-body {
            overflow-y: auto;
            max-height: calc(100vh - 210px);
        }
        .form-label {
            font-weight: 700;
            color: #111827;
        }
        .form-control,
        .form-select {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 0.62rem 0.82rem;
            transition: all .2s ease;
        }
        .form-control:focus,
        .form-select:focus {
            border-color: rgba(60, 141, 188, .55);
            box-shadow: 0 0 0 .2rem rgba(60, 141, 188, .15);
        }
        .help-text {
            color: #6b7280;
            font-size: .84rem;
        }
        .invalid-feedback {
            display: block;
            font-size: .86rem;
        }
        .is-invalid {
            border-color: var(--danger) !important;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <main class="container-fluid py-4 list-wrapper">
        <section class="shell p-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
                <div>
                    <h1 class="h3 mb-1">Acciones del Plan Ambiental</h1>
                    <p class="mb-0 text-muted">Administracion de acciones asociadas a secciones.</p>
                </div>
                <div class="d-flex gap-2">
                    <button th:if="${isAdmin}" type="button" class="btn btn-success"
                            data-bs-toggle="modal" data-bs-target="#accionModal">
                        Nueva accion
                    </button>
                    <a th:href="@{/secciones}" class="btn btn-outline-primary">Ir a secciones</a>
                    <a th:href="@{/home}" class="btn btn-outline-dark">Volver al panel</a>
                </div>
            </div>

            <div th:if="${!isAdmin}" class="alert alert-info mb-4">
                Tu perfil es de solo lectura. Puedes usar DataTables para buscar, ordenar y filtrar.
            </div>

            <table id="tablaAcciones" class="table table-hover table-striped w-100 align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Seccion</th>
                        <th>Aspecto</th>
                        <th>Impacto</th>
                        <th>Medidas</th>
                        <th>Numerador</th>
                        <th>Denominador</th>
                        <th>Estado</th>
                        <th>Color</th>
                        <th>Valor</th>
                        <th>Frecuencia</th>
                        <th>Periodo</th>
                        <th>Creado</th>
                        <th>Editado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="a : ${acciones}">
                        <td th:text="${a.codigoAccion}"></td>
                        <td th:text="${a.seccion != null ? a.seccion.tituloSeccion : '-'}"></td>
                        <td class="truncate" th:text="${a.aspectoAmbientalAccion}" th:title="${a.aspectoAmbientalAccion}"></td>
                        <td class="truncate" th:text="${a.impactoAmbientalAccion}" th:title="${a.impactoAmbientalAccion}"></td>
                        <td class="truncate" th:text="${a.medidasPropuestasAccion}" th:title="${a.medidasPropuestasAccion}"></td>
                        <td th:text="${a.numeradorValorAccion}"></td>
                        <td th:text="${a.denominadorValorAccion}"></td>
                        <td th:text="${a.estadoAplica != null ? (a.estadoAplica == 1 ? 'Aplica' : 'No aplica') : '-'}"></td>
                        <td th:text="${a.colorAccion}"></td>
                        <td th:text="${a.valorAccion}"></td>
                        <td th:text="${a.frecuenciaAccion}"></td>
                        <td th:text="${a.periodoAccion}"></td>
                        <td th:text="${a.fechaCreadoAccion != null ? #temporals.format(a.fechaCreadoAccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td th:text="${a.fechaEditadoAccion != null ? #temporals.format(a.fechaEditadoAccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td>
                            <div th:if="${isAdmin}" class="d-flex gap-2">
                                <a th:href="@{/acciones(editar=${a.codigoAccion})}" class="btn btn-sm btn-outline-warning">Editar</a>
                                <form th:action="@{/acciones/eliminar/{id}(id=${a.codigoAccion})}" method="post"
                                      class="form-eliminar"
                                      th:attr="data-nombre=${a.seccion != null ? ('Accion de ' + a.seccion.tituloSeccion) : 'Accion #' + a.codigoAccion}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                </form>
                            </div>
                            <span th:if="${!isAdmin}" class="badge text-bg-secondary">Sin permisos</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <div th:if="${isAdmin}" class="modal fade" id="accionModal" tabindex="-1" aria-labelledby="accionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(90deg, #0ea5a4, #0b3a53);">
                    <h5 class="modal-title" id="accionModalLabel"
                        th:text="${modoEdicion} ? 'Editar accion' : 'Nueva accion'">Nueva accion</h5>
                    <button type="button" class="btn-close btn-close-white btn-cancelar-modal-accion" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/acciones/guardar}" th:object="${accionForm}" method="post" id="formAccion" novalidate>
                    <div class="modal-body">
                        <input type="hidden" th:field="*{codigoAccion}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="alert alert-danger" th:if="${errorFormulario != null || #fields.hasAnyErrors()}">
                            <div th:if="${errorFormulario != null}" th:text="${errorFormulario}"></div>
                            <ul class="mb-0 mt-2" th:if="${#fields.hasAnyErrors()}">
                                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                            </ul>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Seccion</label>
                                <select class="form-select" name="seccionId" required>
                                    <option value="">Seleccione...</option>
                                    <option th:each="sec : ${secciones}"
                                            th:value="${sec.codigoSeccion}"
                                            th:text="${sec.tituloSeccion}"
                                            th:selected="${seccionIdSeleccionada != null and seccionIdSeleccionada == sec.codigoSeccion}">
                                    </option>
                                </select>
                                <small class="help-text d-block mt-1">Selecciona la seccion a la que pertenece esta accion.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Color accion</label>
                                <input class="form-control" th:field="*{colorAccion}" maxlength="25" placeholder="Ej: Amarillo o #ffc107">
                                <small class="help-text d-block mt-1">Opcional. Nombre o codigo HEX.</small>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Valor accion</label>
                                <input class="form-control" th:field="*{valorAccion}" maxlength="25" placeholder="Ej: Alto, Medio o Bajo">
                                <small class="help-text d-block mt-1">Clasificacion de prioridad o impacto.</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Aspecto ambiental</label>
                                <textarea class="form-control" rows="2" th:field="*{aspectoAmbientalAccion}" maxlength="4000" placeholder="Ej: Emision de gases por uso de combustible."></textarea>
                                <small class="help-text d-block mt-1">Describe el aspecto ambiental identificado.</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Impacto ambiental</label>
                                <textarea class="form-control" rows="2" th:field="*{impactoAmbientalAccion}" maxlength="4000" placeholder="Ej: Incremento de huella de carbono en operaciones."></textarea>
                                <small class="help-text d-block mt-1">Detalla el efecto generado por el aspecto.</small>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold">Medidas propuestas</label>
                                <textarea class="form-control" rows="2" th:field="*{medidasPropuestasAccion}" maxlength="4000" placeholder="Ej: Sustituir equipos por tecnologia eficiente y plan de monitoreo mensual."></textarea>
                                <small class="help-text d-block mt-1">Indica acciones concretas para mitigar el impacto.</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Numerador</label>
                                <input class="form-control" type="number" th:field="*{numeradorValorAccion}" min="0" placeholder="Ej: 3">
                                <small class="help-text d-block mt-1">Opcional. Usa valores enteros.</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Denominador</label>
                                <input class="form-control" type="number" th:field="*{denominadorValorAccion}" min="1" placeholder="Ej: 5">
                                <small class="help-text d-block mt-1">Si lo usas, debe ser mayor a 0.</small>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Estado aplica</label>
                                <select class="form-select" th:field="*{estadoAplica}">
                                    <option value="">Seleccione</option>
                                    <option value="1">Aplica</option>
                                    <option value="0">No aplica</option>
                                </select>
                                <small class="help-text d-block mt-1">Indica si la accion aplica actualmente.</small>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Frecuencia</label>
                                <input class="form-control" type="number" th:field="*{frecuenciaAccion}" min="1" placeholder="Ej: 12">
                                <small class="help-text d-block mt-1">Cantidad de veces en el periodo.</small>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Periodo</label>
                                <input class="form-control" type="text" th:field="*{periodoAccion}" maxlength="255" placeholder="Ej: Mensual">
                                <small class="help-text d-block mt-1">Ejemplos: Diario, Mensual, Trimestral.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a th:if="${modoEdicion}" th:href="@{/acciones}" class="btn btn-outline-secondary btn-cancelar-accion">Cancelar</a>
                        <button type="button" class="btn btn-light border btn-cancelar-modal-accion" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-success"
                                th:text="${modoEdicion} ? 'Actualizar accion' : 'Guardar accion'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="none">
        $(function () {
            $('#tablaAcciones').DataTable({
                responsive: true,
                dom: "<'row mb-2'<'col-md-7'B><'col-md-5'f>>" +
                     "rt" +
                     "<'row mt-3'<'col-md-5'i><'col-md-7'p>>",
                buttons: [
                    { extend: 'copy', text: 'Copiar', className: 'btn btn-secondary btn-sm' },
                    { extend: 'csv', text: 'CSV', className: 'btn btn-success btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } },
                    { extend: 'excel', text: 'Excel', className: 'btn btn-success btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } },
                    { extend: 'pdf', text: 'PDF', className: 'btn btn-danger btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } },
                    { extend: 'print', text: 'Imprimir', className: 'btn btn-dark btn-sm', exportOptions: { columns: ':visible:not(:last-child)' } }
                ],
                pageLength: 10,
                lengthMenu: [ [5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos'] ],
                order: [ [0, 'desc'] ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
                }
            });
        });
    </script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var modoEdicion = /*[[${modoEdicion}]]*/ false;
            var abrirModal = /*[[${abrirModal}]]*/ false;
            var successMessage = /*[[${successMessage}]]*/ null;
            var errorMessage = /*[[${errorMessage}]]*/ null;

            function alertaExito(mensaje) {
                Swal.fire({
                    icon: 'success',
                    title: 'Operacion exitosa',
                    text: mensaje,
                    confirmButtonColor: '#198754'
                });
            }

            function alertaError(mensaje) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ocurrio un problema',
                    text: mensaje,
                    confirmButtonColor: '#dc3545'
                });
            }

            function alertaConfirmar(config) {
                return Swal.fire({
                    title: config.titulo,
                    html: config.html,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: config.confirmText || 'Confirmar',
                    cancelButtonText: config.cancelText || 'Cancelar',
                    confirmButtonColor: config.confirmColor || '#dc3545',
                    cancelButtonColor: '#6c757d'
                });
            }

            if (successMessage) {
                alertaExito(successMessage);
            } else if (errorMessage) {
                alertaError(errorMessage);
            }

            if (modoEdicion || abrirModal) {
                var modalEl = document.getElementById('accionModal');
                if (modalEl) {
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                }
            }

            $(document).on('submit', '.form-eliminar', function (e) {
                e.preventDefault();
                var form = this;
                var nombre = $(form).data('nombre') || 'esta accion';

                alertaConfirmar({
                    titulo: 'Eliminar accion?',
                    html: 'Vas a eliminar <b>' + nombre + '</b><br><span class="text-muted">Esta accion no se puede deshacer</span>',
                    confirmText: 'Eliminar',
                    cancelText: 'Cancelar',
                    confirmColor: '#dc3545'
                }).then(function (result) {
                    if (result.isConfirmed) {
                        form.submit();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Operacion cancelada',
                            text: 'No se elimino la accion.',
                            timer: 1200,
                            showConfirmButton: false
                        });
                    }
                });
            });

            $(document).on('click', '.btn-cancelar-accion', function (e) {
                e.preventDefault();
                var href = this.getAttribute('href');
                alertaConfirmar({
                    titulo: 'Cancelar cambios?',
                    html: 'Se perderan los cambios no guardados.',
                    confirmText: 'Si, cancelar',
                    cancelText: 'Seguir editando',
                    confirmColor: '#0d6efd'
                }).then(function (result) {
                    if (result.isConfirmed && href) {
                        window.location.href = href;
                    }
                });
            });

            $(document).on('click', '.btn-cancelar-modal-accion', function () {
                Swal.fire({
                    icon: 'info',
                    title: 'Operacion cancelada',
                    text: 'Formulario cerrado.',
                    timer: 1200,
                    showConfirmButton: false
                });
            });

            $('#accionModal').on('shown.bs.modal', function () {
                var body = this.querySelector('.modal-body');
                if (body) {
                    body.scrollTop = 0;
                }
            });

            $.validator.addMethod("enteroPositivo", function (value, element) {
                return this.optional(element) || /^\d+$/.test(value);
            }, "Solo se permiten numeros enteros.");

            $.validator.addMethod("denominadorValido", function (value, element) {
                if (!value) return true;
                var numero = parseInt(value, 10);
                return !isNaN(numero) && numero > 0;
            }, "El denominador debe ser mayor a 0.");

            $("#formAccion").validate({
                ignore: [],
                rules: {
                    seccionId: {
                        required: true
                    },
                    colorAccion: {
                        maxlength: 25
                    },
                    valorAccion: {
                        maxlength: 25
                    },
                    aspectoAmbientalAccion: {
                        maxlength: 4000
                    },
                    impactoAmbientalAccion: {
                        maxlength: 4000
                    },
                    medidasPropuestasAccion: {
                        maxlength: 4000
                    },
                    numeradorValorAccion: {
                        enteroPositivo: true,
                        min: 0
                    },
                    denominadorValorAccion: {
                        enteroPositivo: true,
                        denominadorValido: true
                    },
                    frecuenciaAccion: {
                        enteroPositivo: true,
                        min: 1
                    },
                    periodoAccion: {
                        maxlength: 255
                    }
                },
                messages: {
                    seccionId: {
                        required: "Selecciona la seccion."
                    },
                    colorAccion: {
                        maxlength: "No puede superar 25 caracteres."
                    },
                    valorAccion: {
                        maxlength: "No puede superar 25 caracteres."
                    },
                    aspectoAmbientalAccion: {
                        maxlength: "No puede superar 4000 caracteres."
                    },
                    impactoAmbientalAccion: {
                        maxlength: "No puede superar 4000 caracteres."
                    },
                    medidasPropuestasAccion: {
                        maxlength: "No puede superar 4000 caracteres."
                    },
                    numeradorValorAccion: {
                        min: "Debe ser mayor o igual a 0."
                    },
                    frecuenciaAccion: {
                        min: "Debe ser mayor o igual a 1."
                    },
                    periodoAccion: {
                        maxlength: "No puede superar 255 caracteres."
                    }
                },
                errorElement: "div",
                errorClass: "invalid-feedback",
                highlight: function (element) { $(element).addClass("is-invalid"); },
                unhighlight: function (element) { $(element).removeClass("is-invalid"); },
                submitHandler: function (form) { form.submit(); }
            });
        });
    </script>
</body>
</html>
