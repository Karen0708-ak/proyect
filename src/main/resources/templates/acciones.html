<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Acciones del Plan Ambiental</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --head: #0b3a53;
        }
        body {
            background: radial-gradient(circle at 20% 20%, #cbd5e1, #f8fafc 38%),
                        linear-gradient(140deg, #e2e8f0, #f8fafc);
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: #0b3a53;
        }
        .shell {
            background: #fff;
            border-radius: 16px;
            border: 1px solid rgba(11, 58, 83, 0.15);
            box-shadow: 0 18px 40px rgba(11, 58, 83, 0.12);
        }
        .table thead th {
            background: var(--head);
            color: #fff;
            border-bottom: 0;
        }
        .truncate {
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <main class="container-fluid py-4">
        <section class="shell p-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
                <div>
                    <h1 class="h3 mb-1">Acciones del Plan Ambiental</h1>
                    <p class="mb-0 text-muted">Administracion de acciones asociadas a secciones.</p>
                </div>
                <div class="d-flex gap-2">
                    <button th:if="${isAdmin}" type="button" class="btn btn-success"
                            data-bs-toggle="modal" data-bs-target="#accionModal">
                        Nueva accion
                    </button>
                    <a th:href="@{/secciones}" class="btn btn-outline-primary">Ir a secciones</a>
                    <a th:href="@{/home}" class="btn btn-outline-dark">Volver al panel</a>
                </div>
            </div>

            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

            <div th:if="${!isAdmin}" class="alert alert-info mb-4">
                Tu perfil es de solo lectura. Puedes usar DataTables para buscar, ordenar y filtrar.
            </div>

            <table id="tablaAcciones" class="table table-hover table-striped w-100 align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Seccion</th>
                        <th>Aspecto</th>
                        <th>Impacto</th>
                        <th>Medidas</th>
                        <th>Numerador</th>
                        <th>Denominador</th>
                        <th>Estado</th>
                        <th>Color</th>
                        <th>Valor</th>
                        <th>Frecuencia</th>
                        <th>Periodo</th>
                        <th>Creado</th>
                        <th>Editado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="a : ${acciones}">
                        <td th:text="${a.codigoAccion}"></td>
                        <td th:text="${a.seccion != null ? a.seccion.tituloSeccion : '-'}"></td>
                        <td class="truncate" th:text="${a.aspectoAmbientalAccion}" th:title="${a.aspectoAmbientalAccion}"></td>
                        <td class="truncate" th:text="${a.impactoAmbientalAccion}" th:title="${a.impactoAmbientalAccion}"></td>
                        <td class="truncate" th:text="${a.medidasPropuestasAccion}" th:title="${a.medidasPropuestasAccion}"></td>
                        <td th:text="${a.numeradorValorAccion}"></td>
                        <td th:text="${a.denominadorValorAccion}"></td>
                        <td th:text="${a.estadoAplica != null ? (a.estadoAplica == 1 ? 'Aplica' : 'No aplica') : '-'}"></td>
                        <td th:text="${a.colorAccion}"></td>
                        <td th:text="${a.valorAccion}"></td>
                        <td th:text="${a.frecuenciaAccion}"></td>
                        <td th:text="${a.periodoAccion}"></td>
                        <td th:text="${a.fechaCreadoAccion != null ? #temporals.format(a.fechaCreadoAccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td th:text="${a.fechaEditadoAccion != null ? #temporals.format(a.fechaEditadoAccion, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td>
                            <div th:if="${isAdmin}" class="d-flex gap-2">
                                <a th:href="@{/acciones(editar=${a.codigoAccion})}" class="btn btn-sm btn-outline-warning">Editar</a>
                                <form th:action="@{/acciones/eliminar/{id}(id=${a.codigoAccion})}" method="post"
                                      onsubmit="return confirm('Deseas eliminar esta accion?');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                </form>
                            </div>
                            <span th:if="${!isAdmin}" class="badge text-bg-secondary">Sin permisos</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <div th:if="${isAdmin}" class="modal fade" id="accionModal" tabindex="-1" aria-labelledby="accionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(90deg, #0ea5a4, #0b3a53);">
                    <h5 class="modal-title" id="accionModalLabel"
                        th:text="${modoEdicion} ? 'Editar accion' : 'Nueva accion'">Nueva accion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/acciones/guardar}" th:object="${accionForm}" method="post">
                    <div class="modal-body">
                        <input type="hidden" th:field="*{codigoAccion}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Seccion</label>
                                <select class="form-select" name="seccionId" required>
                                    <option value="">Seleccione...</option>
                                    <option th:each="sec : ${secciones}"
                                            th:value="${sec.codigoSeccion}"
                                            th:text="${sec.tituloSeccion}"
                                            th:selected="${seccionIdSeleccionada != null and seccionIdSeleccionada == sec.codigoSeccion}">
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Color accion</label>
                                <input class="form-control" th:field="*{colorAccion}" maxlength="25" placeholder="Verde">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Valor accion</label>
                                <input class="form-control" th:field="*{valorAccion}" maxlength="25" placeholder="Alto / Medio / Bajo">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Aspecto ambiental</label>
                                <textarea class="form-control" rows="2" th:field="*{aspectoAmbientalAccion}"></textarea>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Impacto ambiental</label>
                                <textarea class="form-control" rows="2" th:field="*{impactoAmbientalAccion}"></textarea>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold">Medidas propuestas</label>
                                <textarea class="form-control" rows="2" th:field="*{medidasPropuestasAccion}"></textarea>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Numerador</label>
                                <input class="form-control" type="number" th:field="*{numeradorValorAccion}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Denominador</label>
                                <input class="form-control" type="number" th:field="*{denominadorValorAccion}">
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Estado aplica</label>
                                <select class="form-select" th:field="*{estadoAplica}">
                                    <option value="">Seleccione</option>
                                    <option value="1">Aplica</option>
                                    <option value="0">No aplica</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Frecuencia</label>
                                <input class="form-control" type="number" th:field="*{frecuenciaAccion}">
                            </div>

                            <div class="col-md-2">
                                <label class="form-label fw-bold">Periodo</label>
                                <input class="form-control" type="text" th:field="*{periodoAccion}" maxlength="255" placeholder="Mensual">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a th:if="${modoEdicion}" th:href="@{/acciones}" class="btn btn-outline-secondary">Cancelar</a>
                        <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-success"
                                th:text="${modoEdicion} ? 'Actualizar accion' : 'Guardar accion'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script th:inline="none">
        $(function () {
            $('#tablaAcciones').DataTable({
                responsive: true,
                pageLength: 10,
                lengthMenu: [ [5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos'] ],
                order: [ [0, 'desc'] ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
                }
            });
        });
    </script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var modoEdicion = /*[[${modoEdicion}]]*/ false;
            if (modoEdicion) {
                var modalEl = document.getElementById('accionModal');
                if (modalEl) {
                    bootstrap.Modal.getOrCreateInstance(modalEl).show();
                }
            }
        });
    </script>
</body>
</html>
